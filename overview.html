<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Semesterplan</title>
	<link rel="stylesheet" href="assets/css/overview.css">
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.9.1/underscore-min.js"></script>
	<script>
	let mpmApp = {}
	</script>
	<script type="text/javascript" src="assets/csv/data.js"></script>
	<script type="text/javascript">
		window.csvDefinition = {
			0: 'id',
			1: 'title',
			2: 'thmId',
			3: 'creditPoints',
			4: 'hoursPerWeek',
			5: 'semester',
			6: 'specialization',
			7: 'isMandatory',
			8: 'precursor',
			9: 'successor',
			10: 'examCondition',
			11: 'dependsOn'
		}
		$(document).ready(function(ev) {
			// initialize Data:
			window.allModuleData = parseCsvData(mpmApp.csvData);
			window.currentModuleData = window.allModuleData;
			window.currentlyActiveFilters = [];

			let filters = [];
			// do we came here from a btn?
			// read: do we have a location hash? (url#sth)
			if (window.location.hash) {
				if (window.location.hash === '#medienproduktion') {
					addFilterByAnd('specialization', 'Allgemein')
					addFilterByOr('specialization', 'Medienproduktion')
				} 
				if (window.location.hash === '#webAndMobile') {
					addFilterByAnd('specialization', 'Allgemein')
					addFilterByOr('specialization', 'Web&Mobile')
				}
			}

			forceRerender();
		})

		forceRerender = () => {
			$('#dataTable tr:not(#headerRow)').remove();
			window.currentModuleData.forEach((item) => {
				$('#dataTable').append(`<tr>
					<td>${item.thmId}</td>	
					<td>${item.semester}</td>	
					<td>${item.title}</td>
					<td>${item.specialization}</td>
					<td>${item.isMandatory}</td>
					<td>${item.examCondition}</td>
				</tr>`)
			})

			$('#currentFilters').html('')
			window.currentlyActiveFilters.forEach((item) => {
				let key = Object.keys(item)[0];
				$('#currentFilters').append(key + ': ' + item[key] + '<br />');
			})
		}

		parseCsvData = (dataString) => {
			let lines = dataString.split('\n');
			let linesParsed = lines.map(parseCsvLine)

			return linesParsed;
		} 

		parseCsvLine = (lineString) => {
			let module = {}
			let objectValues = lineString.split(',');
			objectValues.forEach((value, index, array) => {
				if (window.csvDefinition[index]) {
					module[window.csvDefinition[index]] = value;
				}
			})

			return module;
		}

		addFilterByAnd = (property, value) => {
			let keyStr = 'filter-and-' + property;
			let obj = {}
			obj[keyStr] = value;
			window.currentlyActiveFilters.push(obj)
			let filterFn = (module) => {
				return (module[property].trim() == value.trim())
			}

			if (property === '') {
				filterFn = () => {return true};
			}

			let filteredModuleData = _.filter(window.currentModuleData, filterFn);

			window.currentModuleData = filteredModuleData;
			forceRerender();
		}

		hasFilter = (property) => {
			let returnValue = false;
			_.each(window.currentlyActiveFilters, (filter) => {
				let filterName = Object.keys(filter)[0]
				if(filterName.endsWith(property)) {
					returnValue = true;
				}
			});

			return returnValue;
		}

		addFilterByOr = (property, value) => {
			if ((hasFilter('specialization') && !hasFilter('semester')) && property === 'semester' ||
				window.currentlyActiveFilters.length === 0) {
				return addFilterByAnd(property, value);
			}

			let keyStr = 'filter-or-' + property;
			let obj = {}
			obj[keyStr] = value;
			window.currentlyActiveFilters.push(obj)

			console.log('adding or filter');
			let filterFn = (module) => {
				return (module[property].trim() == value.trim())
			}

			if (property === '') {
				filterFn = () => {return true};
			}

			let filteredModuleData = _.filter(window.allModuleData, filterFn);

			window.currentModuleData = _.uniq(_.union(window.currentModuleData, filteredModuleData), false, (item) => {return item.thmId});
			forceRerender();
		}

		clearFilters = () => {
			window.currentlyActiveFilters = [];
			window.currentModuleData = window.allModuleData;
			forceRerender();
		}
	</script>
  </head>
  <body>
	<header>
		<h2>Bachelor of Science</h2>
		<h1>Medieninformatik</h1>
	</header>
		<div id="filter" class="test">
			<nav>
			<ul>
				<li onclick="clearFilters()"><a href="#">Filter Entfernen</a></li>
				<li onclick="addFilterByOr('semester', '1')"><a href="#" >1 Sem.</a></li>
				<li onclick="addFilterByOr('semester', '2')"><a href="#">2 Sem.</a></li>
				<li onclick="addFilterByOr('semester', '3')"><a href="#">3 Sem.</a></li>
				<li onclick="addFilterByOr('semester', '4')"><a href="#">4 Sem.</a></li>
				<li onclick="addFilterByOr('semester', '5')"><a href="#">5 Sem.</a></li>
				<li onclick="addFilterByOr('semester', '6')"><a href="#">6 Sem.</a></li>
				<li><a href="#" aria-haspopup="true">Schwerpunkt</a> <!--hover on touch durch aria attribut -->
					<ul>
						<li onclick="addFilterByAnd('specialization', 'Allgemein')"><a href="#">Allgemein</a></li>
						<li onclick="addFilterByAnd('specialization', 'Web&Mobile')"><a href="#">Web und Mobile</a></li>
						<li onclick="addFilterByAnd('specialization', 'Medienproduktion')"><a href="#">Medienproduktion</a></li>
					</ul>
				</li>
			</ul>
			</nav>
		</div>
		<span id="currentFilters"></span>
		<table id="dataTable">
			<tr id="headerRow">
				<th>THM ID</th>
				<th>Sem.</th>
				<th>Titel</th>
				<th>Schwerpunkt</th>
				<th>Pflicht</th>
				<th>Pr√ºfungsvorleistung</th>
			</tr>
		</table>
  </body>
</html>